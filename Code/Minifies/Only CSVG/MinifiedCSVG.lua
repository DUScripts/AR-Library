positionTypes={globalP=1,localP=2}orientationTypes={globalO=1,localO=2}CameraTypes={fixed={fLocal={name="fLocal",id=0},fGlobal={name="fGlobal",id=1}},player={name="player",id=2}}function getManager()local self={}local function a(b,c,d,e,f,g,h,i,j)local k=b+f+j;if k>0 then local l=0.5/(k+1)^0.5;return(g-i)*l,(h-d)*l,(c-e)*l,0.25/l elseif b>f and b>j then local l=1/(2*(1+b-f-j)^0.5)return 0.25/l,(e+c)*l,(h+d)*l,(g-i)*l elseif f>j then local l=1/(2*(1+f-b-j)^0.5)return(e+c)*l,0.25/l,(i+g)*l,(h-d)*l else local l=1/(2*(1+j-b-f)^0.5)return(h+d)*l,(i+g)*l,0.25/l,(c-e)*l end end;local function m(n,o,p)if o and p then return a(n[1],n[2],n[3],o[1],o[2],o[3],p[1],p[2],p[3])else return a(n[1],n[5],n[9],n[2],n[6],n[10],n[3],n[7],n[11])end end;self.matrixToQuat=a;self.rotMatrixToQuat=m;local function q(r,s)local t,u,v,w,x,type=math.rad,math.sin,math.cos,math.random,system.print,type;local function y(z,A,B,C)if type(z)=='number'then if C==nil then if z==z and A==A and B==B then z=-t(z*0.5)A=t(A*0.5)B=-t(B*0.5)local l,D=u,v;local E,F,G=l(z),l(A),l(B)local H,I,J=D(z),D(A),D(B)return E*I*J-H*F*G,H*F*J+E*I*G,H*I*G-E*F*J,H*I*J+E*F*G else return 0,0,0,1 end else return z,A,B,C end elseif type(z)=='table'then if#z==3 then return m(z,A,B)elseif#z==4 then return z[1],z[2],z[3],z[4]else x('Unsupported Rotation!')end end end;local function K(L,M,N,O,P,Q,R,S)return L*S+O*P+M*R-N*Q,M*S+O*Q+N*P-L*R,N*S+O*R+L*Q-M*P,O*S-L*P-M*Q-N*R end;local function T(L,M,N,O,U,V,W,X,Y,Z)local _,a0,a1,a2=L*L,M*M,N*N,O*O;return 2*(V*(L*M-O*N)+W*(L*N+O*M))+U*(a2+_-a0-a1)+X,2*(U*(O*N+L*M)+W*(M*N-O*L))+V*(a2-_+a0-a1)+Y,2*(U*(L*N-O*M)+V*(L*O+M*N))+W*(a2-_-a0+a1)+Z end;local a3,a4=nil,false;local a5=nil;local a6,a7,a8=s[1],s[2],s[3]local a9,aa,ab=0,0,0;local ac=s;local ad=false;local ae,af,ag,ah=0,0,0,1;local ai,aj,ak,al=0,0,0,1;local am,an,ao,ap=0,0,0,1;local aq,ar,as,at=0,0,0,1;local au=r;local av={}local aw={}local function ax(wx,wy,wz,ww,ay,az,aA,aB,aC,aD)wx,wy,wz,ww=wx or 0,wy or 0,wz or 0,ww or 1;ay,az,aA=ay or a6,az or a7,aA or a8;aB,aC,aD=aB or a6,aC or a7,aD or a8;local aE,aF,aG;if not ad then aE,aF,aG=a6-ay,a7-az,a8-aA else aE,aF,aG=a6,a7,a8 end;if ww~=1 and ww~=-1 then if aE~=0 or aF~=0 or aG~=0 then ac[1],ac[2],ac[3]=T(wx,wy,wz,ww,aE,aF,aG,aB,aC,aD)else ac[1],ac[2],ac[3]=aB,aC+w()*0.00001,aD end;if at~=1 then wx,wy,wz,ww=K(wx,wy,wz,ww,aq,ar,as,at)end;if ap~=1 then wx,wy,wz,ww=K(wx,wy,wz,ww,am,an,ao,ap)end else ac[1],ac[2],ac[3]=aB+aE,aC+aF,aD+aG;if at~=1 then if ap~=1 then wx,wy,wz,ww=K(aq,ar,as,at,am,an,ao,ap)else wx,wy,wz,ww=aq,ar,as,at end else if ap~=1 then wx,wy,wz,ww=am,an,ao,ap end end end;au[1],au[2],au[3],au[4]=wx,wy,wz,ww;for aH=1,#av do av[aH].update(wx,wy,wz,ww,a6,a7,a8,ac[1],ac[2],ac[3])end;a4=false end;aw.update=ax;local function aI()if not a3 then ax()else a3.bubble()end end;local function aJ(aK)if aK then aq,ar,as,at=y(ai,aj,ak,al)else am,an,ao,ap=y(ae,af,ag,ah)end;aI()end;function aw.setSuperManager(aL)a3=aL end;function aw.addSubRotation(aL)aL.setSuperManager(aw)av[#av+1]=aL;ax()end;function aw.bubble()if a3 then a3.bubble()else a4=true end end;a5=aw.bubble;function aw.checkUpdate()if a4 then ax()end;return a4 end;local function aM(aN,aO)aN.update=ax;function aN.getPosition()return a6,a7,a8 end;function aN.getRotationManger()return aw end;function aN.setPosition(aP,aQ,aR)if not(aP~=aP or aQ~=aQ or aR~=aR)then a6,a7,a8=aP,aQ+w()*0.00001,aR;a5()end end;function aN.rotateXYZ(aS,aT,aU,aV)if aS and aT and aU then ae,af,ag,ah=aS,aT,aU,aV;aJ(false)if aO then aO()end else if type(aS)=='table'then if#aS==3 then ae,af,ag,ah=aS[1],aS[2],aS[3],nil;if aO then aO()end;goto aW end end;x('Invalid format. Must be three angles, or right, forward and up vectors, or a quaternion. Use radians if angles.')::aW::end end;function aN.rotateX(aS)ae=aS;ah=nil;aJ(false)if aO then aO()end end;function aN.rotateY(aT)af=aT;ah=nil;aJ(false)if aO then aO()end end;function aN.rotateZ(aU)ag=aU;ah=nil;aJ(false)if aO then aO()end end;function aN.rotateDefaultXYZ(aS,aT,aU,aV)if aS and aT and aU then ai,aj,ak,al=aS,aT,aU,aV;aJ(true)if aO then aO()end else if type(aS)=='table'then if#aS==3 then ai,aj,ak,al=aS[1],aS[2],aS[3],nil;if aO then aO()end;goto aW end end;x('Invalid format. Must be three angles, or right, forward and up vectors, or a quaternion. Use radians if angles.')::aW::end end;function aN.rotateDefaultX(aS)ai=aS;al=nil;aJ(true)if aO then aO()end end;function aN.rotateDefaultY(aT)aj=aT;al=nil;aJ(true)if aO then aO()end end;function aN.rotateDefaultZ(aU)ak=aU;al=nil;aJ(true)if aO then aO()end end;function aN.setPositionIsRelative(aX)ad=true;a5()end end;aw.assignFunctions=aM;return aw end;self.getRotationManager=q;return self end;function Camera(aY,aZ,a_)local t=math.rad;local b0=a_ or{0,0,0,1}local b1=aZ or{0,0,0}local b2=getManager().getRotationManager(a_,aZ)local self={cType=aY or CameraTypes.player,position=b1,orientation=b0}b2.assignFunctions(self)return self end;local x=system.print;function ObjectGroup(b3,b4,b5)local b3=b3 or{}local self={style='',gStyle='',objects=b3,transX=b4,transY=b5,enabled=true,glow=false,gRad=10,scale=false}function self.addObject(b6,b7)local b7=b7 or#b3+1;b3[b7]=b6;return b7 end;function self.removeObject(b7)b3[b7]={}end;function self.hide()self.enabled=false end;function self.show()self.enabled=true end;function self.isEnabled()return self.enabled end;function self.setStyle(b8)self.style=b8 end;function self.setGlowStyle(b9)self.gStyle=b9 end;function self.setGlow(ba,bb,bc)self.glow=ba;self.gRad=bb or self.gRad;self.scale=bc or false end;return self end;function Object(b8,aZ,bd,a_,be,bf,b4,b5)local t,x,w,bg=math.rad,system.print,math.random,getManager()local q=bg.getRotationManager;local aZ=aZ;local bh=bd;local b8=b8;local bi,bj,bk={},{},{}local be=be;local bf=bf;local b0={0,0,0,1}local bl=q(b0,aZ)local bm={}local self={false,false,false,bi,false,bj,bk,be,bf,b0,b8,aZ,bd,b4,b5,bm}function self.addDef(string)bm[#bm+1]=string end;function self.resetDefs()bm={}end;function self.setCustomSVGs(bn,b8,bc)local bo={}local bp={}local bq={b8,bo,bp}local bc=bc or 1;local br,bs=1,1;self[4][bn]=bq;local bd=bh;local bt,bu,bv=bd[1],bd[2],bd[3]local self={}function self.addMultiPointSVG()local bw={}local bx=nil;local by=nil;local self={}local bz=1;function self.addPoint(bA)local bA=bA;bw[bz]={bA[1]/bc+bt,bA[2]/bc-bu,bA[3]/bc-bv}bz=bz+1;return self end;function self.bulkSetPoints(bB)bw=bB;bz=#bw+1;return self end;function self.setData(bC)bx=bC;return self end;function self.setDrawFunction(bD)by=bD;return self end;function self.build()if bz>1 then if by~=nil then bo[br]={bw,by,bx}br=br+1;return bw else x("WARNING! Malformed multi-point build operation, no draw function specified. Ignoring.")end else x("WARNING! Malformed multi-point build operation, no points specified. Ignoring.")end end;return self end;function self.addSinglePointSVG()local self={}local bE={false,false,false,false,false,false}bp[bs]=bE;bs=bs+1;function self.setPosition(aZ)bE[2],bE[3],bE[4]=aZ[1]/bc+bt,aZ[2]/bc-bu,aZ[3]/bc-bv;return self end;function self.setDrawFunction(bD)bE[5]=bD;return self end;function self.setData(bC)bE[6]=bC;return self end;function self.setEnabled(bF)bE[1]=bF;return self end;function self.build()bE[1]=true;return self end;return self end;return self end;bl.assignFunctions(self)function self.addSubObject(b6)bl.addSubRotation(b6.getRotationManager())end;function self.removeSubObject(b7)self[6][b7]={}end;function self.setSubObjects()local self={}local D=1;function self.addSubObject(b6)self[6][D]=b6;D=D+1;return self end;return self end;return self end;function ObjectBuilderLinear()local self={}function self.setStyle(b8)local self={}local b8=b8;function self.setPosition(b1)local self={}local b1=b1;function self.setOffset(bd)local self={}local bd=bd;function self.setOrientation(a_)local self={}local a_=a_;function self.setPositionType(be)local self={}local be=be;function self.setOrientationType(bf)local self={}local bf=bf;local b4,b5=nil,nil;function self.setTranslation(bG,bH)b4,b5=bG,bH;return self end;function self.build()return Object(b8,b1,bd,a_,be,bf,b4,b5)end;return self end;return self end;return self end;return self end;return self end;return self end;return self end;function Projector(bI)local core,system,bg=core,system,getManager()local bJ,bK,bL,bM,bN,x=system.getScreenWidth,system.getScreenHeight,system.getFov,system.getMouseDeltaX,system.getMouseDeltaY,system.print;local bO,bP,bQ,bR=core.getConstructWorldRight,core.getConstructWorldForward,core.getConstructWorldUp,core.getConstructWorldPos;local bS=system.getCameraPos;local bT,bU,bV=system.getCameraForward,system.getCameraRight,system.getCameraUp;local a=bg.matrixToQuat;local bW=math;local u,v,bX,t,bY=bW.sin,bW.cos,bW.tan,bW.rad,bW.atan;local bZ=system.getCameraVerticalFov;local b_=system.getCameraHorizontalFov;local c0=0;local c1={}local self={objectGroups=c1}local c2=false;function self.getSize(c3,c4,c5,c6)local c7=bY(c3,c4)*c0;local c5=c5 or c7;local c6=c6 or c7;if c7>=c5 then return c5 elseif c7<=c6 then return c6 else return c7 end end;function self.addObjectGroup(c8,b7)local c9=b7 or#c1+1;c1[c9]=c8;return c9 end;function self.removeObjectGroup(b7)c1[b7]={}end;local L,M,N,O,ca,cb,cc,cd,ce,cf,cg,ch,ci;function self.getModelMatrix(cj)local l,D=u,v;local ck={}local cl,cm=cj[10],cj[12]local cn,co,cp=cm[1],cm[2],cm[3]local wx,wy,wz,ww=cl[1],cl[2],cl[3],cl[4]if cj[9]==1 then wx,wy,wz,ww=wx*O+ww*L+wy*N-wz*M,wy*O+ww*M+wz*L-wx*N,wz*O+ww*N+wx*M-wy*L,ww*O-wx*L-wy*M-wz*N end;if cj[8]==2 then return wx,wy,wz,ww,cn,co,cp else local cq=bR()local cr,cs,ct=cn-cq[1],co-cq[2],cp-cq[3]return wx,wy,wz,ww,ca*cr+cb*cs+cc*ct,cd*cr+ce*cs+cf*ct,cg*cr+ch*cs+ci*ct end end;function self.getViewMatrix()local cu,cv,J=bQ(),bP(),bO()ca,cb,cc,cd,ce,cf,cg,ch,ci=J[1],J[2],J[3],cv[1],cv[2],cv[3],cu[1],cu[2],cu[3]L,M,N,O=a(ca,cb,cc,cd,ce,cf,cg,ch,ci)local b7=bI.cType.id;local cw,cx=b7==0,b7==1;if cw or cx then local l,D=u,v;local cy=bI.orientation;local cz,cA,cB=cy[1]*0.5,-cy[2]*0.5,cy[3]*0.5;local E,G,F=l(cz),l(cA),l(cB)local H,J,I=D(cz),D(cA),D(cB)local cC,cD,cE,cF=E*J,E*G,H*G,H*J;if cx then wx,wy,wz,ww=cC,cD,cE,cF else local cG,cH,cI,cJ=sx*cF+sw*cC+sy*cE-sz*cD,sy*cF+sw*cD+sz*cC-sx*cE,sz*cF+sw*cE+sx*cD-sy*cC,sw*cF-sx*cC-sy*cD-sz*cE;wx,wy,wz,ww=cG,cH,cI,cJ end else local cK=bS()local cL,cM,cN=cK[1],cK[2],cK[3]local cO,cP,cQ=bT(),bU(),bV()local cR,cS,cT=cP[1],cP[2],cP[3]local cU,cV,cW=cO[1],cO[2],cO[3]local cX,cY,cZ=cQ[1],cQ[2],cQ[3]return cR,cS,cT,cU,cV,cW,cX,cY,cZ,-(cR*cL+cS*cM+cT*cN),-(cU*cL+cV*cM+cW*cN),-(cX*cL+cY*cM+cZ*cN),cL,cM,cN end end;function self.getSVG(c_,d0)local d1=false;if clicked then clicked=false;d1=true end;local isHolding=isHolding;local d2=c_ or{}local d0=d0 or 1;local d3,d4,d5,d6,d7,d8,d9,da,db,dc,dd,de,df,dg,dh=self.getViewMatrix()local di,dj,dk,dl=a(d3,d4,d5,d6,d7,d8,d9,da,db)local bY,dm,dn,dp,dq,dr=bY,table.sort,string.format,table.unpack,table.concat,self.getModelMatrix;local ds=2;local dt,du=bJ()/ds,bK()/ds;local dv=dt/du;local dw=bX(t(b_()*0.5))local function dx(dy,dz)return dy[1]>dz[1]end;local dA=dt/dw;c0=dA;local dB=1/dw;local dC=dB*dv;local dD=dB*dt;local dE=-dC*du;local c1=c1;local dF={}local dG=1;for aH=1,#c1 do local c8=c1[aH]if c8.enabled==false then goto dH end;local dI=c8.transX or dt;local dJ=c8.transY or du;local b3=c8.objects;local dK,dL=0,0;local dM,dN,dO,dP,dQ,dR={},{},{},{},0,0;local dS,dT,dU,dV={},{},1,1;local dW=true;for dX=1,#b3 do local dY=b3[dX]if dY[12]==nil then goto dZ end;local cG,cH,cI,cJ,d_,e0,e1=dr(dY)local e2=dY[11]local e3,e4,e5,e6=cG*dl+cJ*di+cH*dk-cI*dj,cH*dl+cJ*dj+cI*di-cG*dk,cI*dl+cJ*dk+cG*dj-cH*di,cJ*dl-cG*di-cH*dj-cI*dk;local e7,e8,e9=e3*e3,e4*e4,e5*e5;local ea,eb,ec,ed=(1-2*(e8+e9))*dD,2*(e3*e4+e5*e6)*dD,2*(e3*e5-e4*e6)*dD,(dc+d3*d_+d4*e0+d5*e1)*dD;local ee,ef,eg,eh=2*(e3*e4-e5*e6),1-2*(e7+e9),2*(e4*e5+e3*e6),dd+d6*d_+d7*e0+d8*e1;local ei,ej,ek,el=2*(e3*e5+e4*e6)*dE,2*(e4*e5-e3*e6)*dE,(1-2*(e7+e8))*dE,(de+d9*d_+da*e0+db*e1)*dE;dK=dK+eh;dL=dL+1;local em,en,eo=df-d_,dg-e0,dh-e1;local bi,bj=dY[4],dY[6]for ep=1,#bi do local eq=bi[ep]local er=eq[2]local es=eq[3]for et=1,#er do local eu=er[et]local ev=eu[1]local ew={}local ex=1;local ey=0;for bz=1,#ev do local ez=ev[bz]local z,A,B=ez[1],ez[2],ez[3]local eA=ee*z+ef*A+eg*B+eh;if eA<0 then goto eB end;ew[ex]={(ea*z+eb*A+ec*B+ed)/eA,(ei*z+ej*A+ek*B+el)/eA,eA}ey=ey+eA;ex=ex+1::eB::end;if ex~=1 then local by=eu[2]local bx=eu[3]dR=dR+1;local eC=ey/(ex-1)dN[dR]=eC;dM[eC]={ew,bx,by}end end;for eD=1,#es do local eE=es[eD]if not eE[1]then goto eF end;local z,A,B=eE[2],eE[3],eE[4]local eA=ee*z+ef*A+eg*B+eh;if eA<0 then goto eF end;local by=eE[5]local bx=eE[6]dR=dR+1;dN[dR]=eA;dM[eA]={(ea*z+eb*A+ec*B+ed)/eA,(ei*z+ej*A+ek*B+el)/eA,bx,by,isCustomSingle=true}::eF::end end::dZ::end;dm(dN)for eG=dR,1,-1 do local eH=dN[eG]local eI=dM[eH]if eI.isCustomSingle then local z,A,bx,by=eI[1],eI[2],eI[3],eI[4]local eJ=#dS;dT[dV]=by(z,A,eH,bx,dS,dU)or'<text x=0 y=0>Error: N-CS</text>'dV=dV+1;local eK=#dS;if eJ~=eK then dU=eK+1 end else local bw,bx,by=eI[1],eI[2],eI[3]local eJ=#dS;dT[dV]=by(bw,bx,dS,dU)dV=dV+1;local eK=#dS;if eJ~=eK then dU=eK+1 end end end;local eL={dn('<svg viewbox="-%g -%g %g %g">',dI,dJ,dt*2,du*2),dn('<style> svg{width:%gpx;height:%gpx;position:absolute;top:0px;left:0px;} %s </style>',dt*ds,du*ds,c8.style),dn(dq(dT),dp(dS)),'</svg>'}if dL>0 then local eM=dK/dL;dF[dG]={eM,dq(eL)}dG=dG+1;if c8.glow then local c3;if c8.scale then c3=bY(c8.gRad,eM)*dA else c3=c8.gRad end;eL[1]=dn('<svg viewbox="-%g -%g %g %g" class="blur">',dI,dJ,dt*2,du*2)eL[2]=[[
                        <style> 
                            .blur {
                                filter: blur(]]..c3 ..[[px) 
                                        brightness(60%)
                                        saturate(3);
                                ]]..c8.gStyle..[[
                            }
                        </style>]]dF[dG]={eM+0.1,dq(eL)}dG=dG+1 end end::dH::end;dm(dF,dx)local eN=#dF;if eN>0 then d0=d0-1;for eO=1,eN do d2[d0+eO]=dF[eO][2]end end;return d2,d0+eN+1 end;return self end